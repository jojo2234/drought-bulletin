<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="author" content="Alessandro Mazzeo" />
    <title>Drought Bulletin</title>
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="css/my.css" />
    <link rel="icon" href="img/favicon.png" />
    <script>
        if (navigator.userAgent.search(".NET") >= 0 || navigator.userAgent.search("Edge/18") >= 0) {
            alert("Attenzione, il vostro browser potrebbe non essere supportato.")
        }
    </script>
    <script src="js/lib.js"></script>
    <script src="leaflet/leaflet.js"></script>
    <script src="js/jquery.min.js"></script>
</head>
<body>
    <div id='mapid'></div>
</body>
<script>
var satellite = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery from <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/satellite-v9',
        tileSize: 512,
        zoomOffset: -1,
        layers: [satellite, standard],
        accessToken: 'your.mapbox.access.token'
    })
var streets   = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery from <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        layers: [satellite, standard],
        accessToken: 'your.mapbox.access.token'
    })

var standard = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery from <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'your.mapbox.access.token'
    });

//var mymap = L.map('mapid').setView([42.60744445999161, 11.7342599416889], 7);
var mymap = L.map('mapid', {
        center: [42.60744445999161, 11.7342599416889],
        zoom: 7,
        layers: [satellite, standard]
    });

    var baseMaps = {
    "Satellite": satellite,
    "Streets": standard
    };

    var overlayMaps = {
        "Standard": standard
    };

    L.control.layers(baseMaps, overlayMaps).addTo(mymap);

    var baseMaps = {
    "<span>Satellite</span>": satellite,
    "<span>Streets</span>": standard
    };

    function riempiCampiData() {
        //var mesesel = document.getElementById("mesi").value;
        $.getJSON("api/queries.php?funzione=3",function (data){//:"+mesesel, function (data) {
        var valoriDate = [];
         for (i = 0; i < data.length; i++) {
            valoriDate[i] = (data[i]["data"]);
        }
        document.getElementById("data").innerHTML = '<option value="' + valoriDate[0] + '">' + valoriDate[0] + '</option>';
        for (i = 1; i < (valoriDate.length); i++) {
            document.getElementById("data").innerHTML = document.getElementById("data").innerHTML + '<option value="' + valoriDate[i] + '">' + valoriDate[i] + '</option>';   
        }
    });
    }

    function riempiCampiMesi(){
        var mesesel = document.getElementById("data").value;
        $.getJSON("api/queries.php?funzione=1:"+mesesel, function (data) {
        var valoriSPI = [];
         for (i = 0; i < data.length; i++) {
            valoriSPI[i] = (data[i]["mese"]);
        }
        document.getElementById("mesi").innerHTML = '<option value="' + valoriSPI[0] + '">' + valoriSPI[0] + '</option>';
        for (i = 1; i < (valoriSPI.length); i++) {
            document.getElementById("mesi").innerHTML = document.getElementById("mesi").innerHTML + '<option value="' + valoriSPI[i] + '">' + valoriSPI[i] + '</option>';   
        }
    });
    }

    function getMed(vet = new Array()){
        var latv = [];
        var lonv = [];
        for(var i=0;i<vet[0].length;i++){
            latv[i] = vet[0][i][0]; //42..Latitudine utmy
            lonv[i] = vet[0][i][1]; //13..Logitudine utmx
        }
        var centroXY = [(Math.max(...latv)+Math.min(...latv))/2,(Math.max(...lonv)+Math.min(...lonv))/2];
        if(isNaN(centroXY[0])){
            centroXY[0] = 0;
        }
        if(isNaN(centroXY[1])){
            centroXY[1] = 0;
        }
        return centroXY;
    }
    
    var geojsonFeature = '{"type":"FeatureCollection", "features":[';
    function mostraSPI() {
        var mesesel = document.getElementById("mesi").value;
        var datael = document.getElementById("data").value;
        $.getJSON("api/queries.php?funzione=2:"+mesesel+":"+datael, function (data) {
            var centroidXY = [0,0];
            centroidXY = getMed(JSON.parse(data[0]["Poligono"]));//Se nel database il poligono non Ã¨ rinchiuso tra virgolette
            var utmCoords = [0,0];
            MapLatLonToXY(DegToRad(centroidXY[1]), DegToRad(centroidXY[0]), DegToRad(centroidXY[1]), utmCoords);
            geojsonFeature += '{"type":"Feature","geometry":{"type":"Polygon","coordinates":'+(data[0]["Poligono"])+'},"properties":{"idCella":'+JSON.parse(data[0]["ID"])+',"spi":'+JSON.parse(data[0]["SPI"])+',"utmx":'+(utmCoords[0])+',"utmy":'+(utmCoords[1])+',"latCentroid":'+centroidXY[1]+',"lngCentroid":'+centroidXY[0]+'}}';
            for (i = 1; i < data.length; i++) {
                centroidXY = getMed(JSON.parse(data[i]["Poligono"]));
                MapLatLonToXY(DegToRad(centroidXY[1]), DegToRad(centroidXY[0]), DegToRad(centroidXY[1]), utmCoords);
                geojsonFeature += ',{"type":"Feature","geometry":{"type":"Polygon","coordinates":'+(data[i]["Poligono"])+'},"properties":{"idCella":'+JSON.parse(data[i]["ID"])+',"spi":'+JSON.parse(data[i]["SPI"])+',"utmx":'+(utmCoords[0])+',"utmy":'+(utmCoords[1])+',"latCentroid":'+centroidXY[1]+',"lngCentroid":'+centroidXY[0]+'}}';
            }
            geojsonFeature += ']}';
            function getColor(d) {
                return d > 3 ? '#000' : //nero
                    d > 2 ? '#2f71ec' : //blu
                        d > 1.5 ? '#5af53b' : //verde
                            d > -1.5 ? '#d9dadb42' : //Grigio chiaro
                                d > -2 ? '#eea724' ://arancione
                                    d > -3 ? '#e01f1f' : //rosso
                                        d > -4 ? '#6b0404' : //rosso scuro o marrone
                                            '#da22ac';
            }

            function style(feature) {
                return {
                    fillColor: getColor(feature.properties.spi),
                    weight: 1,
                    opacity: 0.4,
                    color: 'white',
                    dashArray: '1',
                    fillOpacity: 1
                };
            }
            var tmpJSON = JSON.parse(geojsonFeature);
            L.geoJSON(tmpJSON).addTo(mymap);
            L.geoJson(tmpJSON, { style: style }).addTo(mymap);
        });
    }

    var legend = L.control({position: 'topleft'});
    legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'legenda');
    div.innerHTML = '<div class="mainBar"><span>Data: <select id="data" onchange="riempiCampiMesi()"><option value="2020-12-01">2020-12-01</option></select></span><span> Mese: <select id="mesi" onchange="mostraSPI()"><option value="1">1</option></select></span></div>';
    div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
    return div;
    };
    legend.addTo(mymap);

    document.getElementsByClassName('legenda leaflet-control')[0].style = "top:20px;left:16px;";
    document.getElementsByClassName('leaflet-control-container')[0].append(document.getElementsByClassName('legenda leaflet-control')[0]);
    //document.getElementsByClassName('legenda leaflet-control')[0].style = "top:0px;left:0px;visibility:hidden;display:none;";
    var imel = document.createElement("img");
    imel.setAttribute("src", "img/s.png");
    imel.setAttribute("width", "14");
    imel.setAttribute("style","padding-left: 5px;vertical-align: middle;");
    var imal = document.createElement("img");
    imal.setAttribute("src", "img/l.png");
    imal.setAttribute("width", "14");
    imal.setAttribute("style","padding-left: 10px;vertical-align: middle;");
    document.getElementsByTagName('label')[0].append(imel);
    document.getElementsByTagName('label')[1].append(imal);
    document.getElementsByTagName('label')[0].firstChild.style="display: inline;";
    document.getElementsByTagName('label')[1].firstChild.style="display: inline;";
    riempiCampiData();
/*
    var legend = L.control({position: 'topright'});
    legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend');
    div.innerHTML = '<select id="mesi" onchange="riempiCampiData()"><option value="1">1</option><option value="3">3</option><option value="6">6</option><option value="9">9</option><option value="12">12</option><option value="24">24</option></select>';
    div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
    return div;
    };
    legend.addTo(mymap);*/
    
/*
    L.geoJSON(appJSONcen, {
        style: function (feature) {
            return {color: feature.properties.color};
        }
    }).bindPopup(function (layer) {
        return layer.feature.properties.description;
    }).addTo(map);*/

</script>

</html>