<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" /><!-- Viewport fullscreen, compatibile with mobile phone (maybe)-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="author" content="Alessandro Mazzeo" />
    <title>Drought Bulletin</title><!--CSS leaflet has been modded by me-->
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="css/my.css" />
    <link rel="icon" href="img/favicon.png" /><!--Title bar icon should be changed-->
    <script>
        /**
         *If the browser is Internet Explorer or Microsoft Edge a compatibility warning appear 
         **/
        if (navigator.userAgent.search(".NET") >= 0 || navigator.userAgent.search("Edge/18") >= 0) {
            alert("Warning, your browser could not be supported.")
        }
    </script>
    <!--<script src="js/lib.js"></script>--><!--Used to convert latitude and longitude in UTM, not more used!-->
    <script src="leaflet/leaflet.js"></script><!--Leaflet make the map-->
    <script src="js/jquery.min.js"></script><!--JQuery liberary min used to get data via JSON-->
</head>
<body>
    <div id='mapid'></div> <!--The map is inserte here!-->
</body>
<!-- All main javascript is inserted in the html page due to performance results-->
<script>
var satellite = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery from <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/satellite-v9',
        tileSize: 512,
        zoomOffset: -1,
        layers: [satellite, standard],
        accessToken: 'your.mapbox.access.token'
    }) //Save the map layer satellite tiles from mapbox website

var standard = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery from <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'your.mapbox.access.token'
    });//Save the map layer street tiles from mapbox website

var mymap = L.map('mapid', {
        center: [42.60744445999161, 11.7342599416889],
        zoom: 7,
        layers: [standard, satellite]
    }); //Load layers

    var baseMaps = {
    "Satellite": satellite,
    "Streets": standard
    };//Used for layer button

    var overlayMaps = {
        "Standard": standard
    };//Used for layer button

    L.control.layers(baseMaps, overlayMaps).addTo(mymap); //Add layer button to the map

    var baseMaps = {
    "<span>Satellite</span>": satellite,
    "<span>Streets</span>": standard
    }; //Modify variable used in layer button
    var noRefresh = 0;
    var layerGEO;
    var celleGeo;
    /**
     * Fill drop-down menu (combo box) with data value stored in database each time the page is refreshed
     **/
    function riempiCampiData() {
        //var mesesel = document.getElementById("mesi").value;
        $.getJSON("api/queries.php?funzione=3",function (data){//:"+mesesel, function (data) {
        var valoriDate = [];
         for (i = 0; i < data.length; i++) {
            valoriDate[i] = (data[i]["data"]);
        }
        document.getElementById("data").innerHTML = '<option value="' + valoriDate[0] + '">' + valoriDate[0] + '</option>';
        for (i = 1; i < (valoriDate.length); i++) {
            document.getElementById("data").innerHTML = document.getElementById("data").innerHTML + '<option value="' + valoriDate[i] + '">' + valoriDate[i] + '</option>';   
        }
        riempiCampiMesi();
    });
    }

    /**
     * Fill drop-down menu (combo box) SPI index every time data change
     **/
    function riempiCampiMesi(){
        var mesesel = document.getElementById("data").value;
        $.getJSON("api/queries.php?funzione=1:"+mesesel, function (data) {
        var valoriSPI = [];
         for (i = 0; i < data.length; i++) {
            valoriSPI[i] = (data[i]["mese"]);
        }
        document.getElementById("mesi").innerHTML = '<option value="' + valoriSPI[0] + '">' + valoriSPI[0] + '</option>';
        for (i = 1; i < (valoriSPI.length); i++) {
            document.getElementById("mesi").innerHTML = document.getElementById("mesi").innerHTML + '<option value="' + valoriSPI[i] + '">' + valoriSPI[i] + '</option>';   
        }
        mostraSPI();
        });
    }

    function getMed(vet = new Array()){ //Questo valore va nel db non calcolarlo qui
        var latv = [];
        var lonv = [];
        for(var i=0;i<vet[0].length;i++){
            latv[i] = vet[0][i][0]; //42..Latitudine utmy
            lonv[i] = vet[0][i][1]; //13..Logitudine utmx
        }
        var centroXY = [(Math.max(...latv)+Math.min(...latv))/2,(Math.max(...lonv)+Math.min(...lonv))/2];
        if(isNaN(centroXY[0])){
            centroXY[0] = 0;
        }
        if(isNaN(centroXY[1])){
            centroXY[1] = 0;
        }
        return centroXY;
    }

    var tmpJSON;
    var geojsonFeature = '{"type":"FeatureCollection", "features":['; //Used to store the GeoJSON string

    function draRemCelle(){
        if(document.getElementById("celid").checked == true){
            mymap.removeLayer(layerGEO);
            celleGeo = L.geoJSON(tmpJSON).addTo(mymap);
            layerGEO.addTo(mymap);
        }else{
            mymap.removeLayer(celleGeo);
        }
    }

    /**
     * Function mostraSPI() called when months SPI is selected
     * This function retrive SPI values and fit it in a GeoJSON format
     **/
    function mostraSPI() {
        var mesesel = document.getElementById("mesi").value;
        var datael = document.getElementById("data").value;
        $.getJSON("api/queries.php?funzione=2:"+mesesel+":"+datael, function (data) {
            //var centroidXY = [0,0];
            //centroidXY = getMed(JSON.parse(data[0]["Poligono"]));//Se nel database il poligono non Ã¨ rinchiuso tra virgolette
            //alert("ECCO: "+JSON.parse(data[0]["Centroide"])[1] + " - " + centroidXY[0]+" | "+JSON.parse(data[0]["Centroide"])[0] + " - " + centroidXY[1]);
            //var utmCoords = [0,0];
            //MapLatLonToXY(DegToRad(centroidXY[1]), DegToRad(centroidXY[0]), DegToRad(centroidXY[1]), utmCoords);
            geojsonFeature += '{"type":"Feature","geometry":{"type":"Polygon","coordinates":'+(data[0]["Poligono"])+'},"properties":{"idCella":'+JSON.parse(data[0]["ID"])+',"spi":'+JSON.parse(data[0]["SPI"])+',"latCentroid":'+JSON.parse(data[0]["Centroide"])[0]+',"lngCentroid":'+JSON.parse(data[0]["Centroide"])[1]+'}}';
            for (i = 1; i < data.length; i++) {
                //centroidXY = getMed(JSON.parse(data[i]["Poligono"]));
                //MapLatLonToXY(DegToRad(centroidXY[1]), DegToRad(centroidXY[0]), DegToRad(centroidXY[1]), utmCoords);
                geojsonFeature += ',{"type":"Feature","geometry":{"type":"Polygon","coordinates":'+(data[i]["Poligono"])+'},"properties":{"idCella":'+JSON.parse(data[i]["ID"])+',"spi":'+JSON.parse(data[i]["SPI"])+',"latCentroid":'+JSON.parse(data[i]["Centroide"])[0]+',"lngCentroid":'+JSON.parse(data[i]["Centroide"])[1]+'}}';
            }
            geojsonFeature += ']}';
            function getColor(d) {
                return d > 3 ? '#000' : //nero
                    d > 2 ? '#2f71ec' : //blu
                        d > 1.5 ? '#5af53b' : //verde
                            d > -1.5 ? '#d9dadb42' : //Grigio chiaro
                                d > -2 ? '#eea724' ://arancione
                                    d > -3 ? '#e01f1f' : //rosso
                                        d > -4 ? '#6b0404' : //rosso scuro o marrone
                                            '#da22ac';
            }
            /**
             *With this function colors are shown.
             **/
            function style(feature) {
                return {
                    fillColor: getColor(feature.properties.spi),
                    weight: 1,
                    opacity: 0.4,
                    color: getColor(feature.properties.spi),
                    dashArray: '1',
                    fillOpacity: 1
                };
            }
            //document.getElementsByTagName('body')[0].innerHTML = geojsonFeature;
            tmpJSON = JSON.parse(geojsonFeature);
            geojsonFeature = '{"type":"FeatureCollection", "features":['; //Solved issue, after data were showed the variable was fill of unused GeoJSON string and that was preventing to show the new data.
            //Previous layer is removed if the page hasn't been refreshed.
            //celleGeo = L.geoJSON(tmpJSON).addTo(mymap);//This show the blue grid!!!!!
            if(noRefresh){
                mymap.removeLayer(layerGEO);
            }
            layerGEO = L.geoJson(tmpJSON, { style: style }).addTo(mymap); //This show only the colored grid sections
            noRefresh = 1;
        });
    }

    var legend = L.control({position: 'topleft'});//This move the controls with drop down menu on top left of screen
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legenda');
        div.innerHTML = '<div class="mainBar"><span>Date: <select id="data" onchange="riempiCampiMesi()"><option value="2020-12-01">2020-12-01</option></select></span><span> Month: <select id="mesi" onchange="mostraSPI()"><option value="1">1</option></select></span><span>Cells: <input type="checkbox" id="celid" onclick="draRemCelle()"/></span></div><div id="colleg"><img src="img/pl.png"/></div>';
        div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
        return div;
    }; //This add the div section that contains the drop down menu called mainBar
    legend.addTo(mymap); //Adding the mainBar to the map
    document.getElementsByClassName('legenda leaflet-control')[0].style = "top:20px;left:16px;";//Changing the position of the main bar
    document.getElementsByClassName('leaflet-control-container')[0].append(document.getElementsByClassName('legenda leaflet-control')[0]); //Changing the position in the document tree
    //document.getElementsByClassName('legenda leaflet-control')[0].style = "top:0px;left:0px;visibility:hidden;display:none;";
    var imel = document.createElement("img"); //Adding an icon for layer satellite
    imel.setAttribute("src", "img/s.png");
    imel.setAttribute("width", "14");
    imel.setAttribute("style","padding-left: 5px;vertical-align: middle;");
    var imal = document.createElement("img"); //Adding an icon for layer streets
    imal.setAttribute("src", "img/l.png");
    imal.setAttribute("width", "14");
    imal.setAttribute("style","padding-left: 10px;vertical-align: middle;");
    document.getElementsByTagName('label')[0].append(imel); //Appending the image to the label (street, satellite)
    document.getElementsByTagName('label')[1].append(imal);
    document.getElementsByTagName('label')[0].firstChild.style="display: inline;"; //Changing css of those labels
    document.getElementsByTagName('label')[1].firstChild.style="display: inline;";
    riempiCampiData();//When everything is done the function to fill the data drop-down menu is called
    document.getElementsByClassName('leaflet-control-container')[0].append(document.getElementById("colleg"));
    //If the used browser is Internet Explorer (not supported) or Microsoft Edge (old version supported)
    //This if move the mainbar at the top of body in this way it works
    if (navigator.userAgent.search(".NET") >= 0 || navigator.userAgent.search("Edge/18") >= 0) {
        document.getElementsByClassName('legenda leaflet-control')[0].style = "top:20px;left:16px;font-size:12px;";
        document.getElementsByTagName("body")[0].insertBefore(document.getElementsByClassName('legenda leaflet-control')[0],document.getElementsByTagName("body")[0].firstChild);
    }
</script>

</html>