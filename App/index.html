<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" /><!-- Viewport fullscreen, compatibile with mobile phone (maybe)-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="author" content="Alessandro Mazzeo" />
    <title>Drought Bulletin</title>
    <!--CSS leaflet has been modded by me-->
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="css/my.css" />
    <link rel="icon" href="img/favicon.png" />
    <!--Title bar icon should be changed-->
    <script>
        /**
         *If the browser is Internet Explorer or Microsoft Edge a compatibility warning appear 
         **/
        if (navigator.userAgent.search(".NET") >= 0 || navigator.userAgent.search("Edge/18") >= 0) {
            alert("Warning, your browser could not be supported.");
        }
    </script>
    <!--<script src="js/lib.js"></script>-->
    <!--Used to convert latitude and longitude in UTM, not more used!-->
    <script src="js/jquery.min.js"></script>
    <!--JQuery liberary min used to get data via JSON-->
    <script src="leaflet/leaflet.js"></script>
    <!--Leaflet make the map-->
    <script src="./js/jquery.min.js"></script>
    <script src="./js/ammap.js"></script>
    <script src="./js/amcharts.js"></script>
    <script src="./js/serial.js"></script>
    <script src="./js/light.js"></script>
    <script src="am4/core.js"></script>
    <script src="am4/charts.js"></script>
    <script src="am4/themes/animated.js"></script>
</head>
<body>
    <div id='mapid'>
        <div id='overPluvo' style="visibility: hidden;overflow-y: auto;" onmouseover='disableDrag()' onmouseout='enableDrag()'>
            <p>Loading..</p>
        </div>
    </div>
    <!--The map is inserted here!-->
</body>
<!-- All main javascript is inserted in the html page due to performance results-->
<script>
    var noRefresh = 0;
    var layerGEO;
    var celleGeo;
    var statsPos;
    var SPIcol = ['#000', '#2f71ec', '#5af53b', '#d9dadb42', '#eea724', '#e01f1f', '#6b0404', '#da22ac'];
    var opacLay = 0.7;
    var idDivPrec; //Used to give station id to amcharts
    var oldGraph = false;
    var showSPI = true;
    var lstCldM;
    //'tiles/st/{z}/{x}/{y}.jpg'
    //'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g'
    var satellite = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery from MOBAC',
        maxZoom: 11,
        id: 'mapbox/satellite-v9',
        tileSize: 256,
        /*zoomOffset: -1,*/
        layers: [satellite, standard],
        accessToken: 'your.mapbox.access.token'
    }); //Save the map layer satellite tiles from mapbox website
    //'tiles/sr/{z}/{x}/{y}.png'
    //Old maps payment now are offline 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g'
    var standard = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibG9iZXJyeSIsImEiOiJja2k1cGppY2gwMmI5MnhwNnQ4aXB6YnV3In0.77-4bVfokUGy9V0RKNag1g', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery from MOBAC',
        maxZoom: 13,
        id: 'mapbox/streets-v11',
        tileSize: 256,
        /*zoomOffset: -1,*/
        accessToken: 'your.mapbox.access.token'
    });//Save the map layer street tiles from mapbox website

    var mymap = L.map('mapid', {
        center: [42.60744445999161, 12.7342599416889],
        zoom: 8,
        layers: [satellite, standard]
    }); //Load layers

    var baseMaps = {
        "Satellite": satellite,
        "Streets": standard
    };//Used for layer button

    var overlayMaps = {
        "Standard": standard
    };//Used for layer button

    L.control.layers(baseMaps, overlayMaps).addTo(mymap); //Add layer button to the map

    var baseMaps = {
        "<span>Satellite</span>": satellite,
        "<span>Streets</span>": standard
    }; //Modify variable used in layer button

    function closeWin() {
        document.getElementById("overPluvo").style = "visibility:hidden";
        document.getElementById("chdivg").remove();
    }

    function chGrph(){
        (oldGraph==false)?oldGraph=true:oldGraph=false;
        if(lstCldM != undefined){
            if(lstCldM == true){
                if(oldGraph == true){
                    pluvoGraphMonthlyOld();
                }else{
                    pluvoGraphMonthly();
                }
            }else{
                if(oldGraph == true){
                    pluvoGraphDailyOld();
                }else{
                    pluvoGraphDaily();
                }
            }
        }
    }

    /**
     * This function show a div box where to get data about the selected pluviometric station
     **/
    function showDivPrec(elem) {
        document.getElementById("overPluvo").style = "visibility:visible";
        idDivPrec = elem;
        $.getJSON("api/queries.php?funzione=5&id=" + elem, function (data) {
            document.getElementById("overPluvo").innerHTML = "<div style='font-weight:bold;width:100%;padding-top:3px;'>ID: " + elem + " Nome: " + data[0]["Nome"] + " QuotaDTM: " + data[0]["QuotaDTM"] + " Codice Distretto: " + data[0]["ID_Distretto"] + "<span style='text-align:right;float:right;padding-right:5px;'><a href='#' style='color:gray;text-decoration:none;font-size:14px;' onclick='closeWin()'>X</a></span></div><p>Show information in a date range or for each year in that month.</p><br/><div>From date: <input id='indt' type='date' onchange='pluvoGraphDaily()'/> To: <input id='fidt' type='date' onchange='pluvoGraphDaily()'/> or select month: <select id='selmo' onchange='pluvoGraphMonthly()' style='margin-right:4px;'><option value='0'></option><option value='1'>January</option><option value='2'>February</option><option value='3'>March</option><option value='4'>April</option><option value='5'>May</option><option value='6'>June</option><option value='7'>July</option><option value='8'>August</option><option value='9'>September</option><option value='10'>October</option><option value='11'>November</option><option value='12'>December</option></select><div id='spon'></div><div id='chdivg'></div><label> Change graphs: </label><input id='oldGraph' type='checkbox' onchange='chGrph()'/></div>";
            $.getJSON("api/queries.php?funzione=8&id=" + elem, function (data) {
                if (data == undefined || data.length <= 0) {
                    document.getElementById("selmo").disabled = true;
                }
            });
            document.getElementById("spon").style="display:inline-block;";
            $.getJSON("api/queries.php?funzione=9&id="+elem, function (data){
                if(data == null || data == undefined){//if(data[0]["Data"]==undefined || data[0]["Data"]==""){
                    if(document.getElementById("selmo").disabled == true){
                        document.getElementById("chdivg").innerHTML = '<br/><h3 style="text-align:center;">No data available for the selected station!</h3>';
                    }else{
                        document.getElementById("selmo").selectedIndex = 2;
                        pluvoGraphMonthly();
                    }
                    document.getElementById("spon").style="display:none;";
                }else{
                    document.getElementById("fidt").value = data[0]["Data"];
                    var d = new Date(data[0]["Data"]);
                    d.setMonth(d.getMonth() - 3);
                    var meseZ = d.getMonth()+1;
                    if((meseZ)<=9){meseZ="0"+meseZ.toString()};
                    document.getElementById("indt").value = (d.getFullYear()+"-"+meseZ+"-"+d.getDate());
                    pluvoGraphDaily();
                    document.getElementById("spon").style="display:none;";
                }
            });
        });
    }

    /**
     * Fill drop-down menu (combo box) with data value stored in database each time the page is refreshed
     **/
    function riempiCampiData() {
        $.getJSON("api/queries.php?funzione=3", function (data) {//:"+mesesel, function (data) {
            var valoriDate = [];
            for (i = 0; i < data.length; i++) {
                valoriDate[i] = (data[i]["data"]);
            }
            document.getElementById("data").innerHTML = '<option value="' + valoriDate[0] + '">' + valoriDate[0].substring(0,7) + '</option>';
            for (i = 1; i < (valoriDate.length); i++) {
                document.getElementById("data").innerHTML = document.getElementById("data").innerHTML + '<option value="' + valoriDate[i] + '">' + valoriDate[i].substring(0,7) + '</option>';
            }
            riempiCampiMesi();
        });
    }

    /**
     * Manage click events on pluvo stations 
     **/
    function setClickOnStat(feature, layer) {
        if (feature.properties && feature.properties.name) {
            layer.bindPopup("<div style='text-align: center;'><p style='margin-bottom: 0px;'>" + feature.properties.name + "</p><p style='font-size:10px;font-style:italic;margin-top: 0px;'><a id='" + feature.properties.idSta + "' href='#' onclick='showDivPrec(this.id)'>Explore</a></p></div>");
            layer.on('mouseover', function (e) {this._icon.src = "leaflet/images/sbt.png";});
            layer.on('mouseout', function (e) {this._icon.src = "leaflet/images/marker-icon.png";});
        }
    }

    //Set the Pop up SPI value on click
    function onEachFeature(feature, layer) {
        if (feature.properties && feature.properties.spi) {
            layer.bindPopup("SPI=" + feature.properties.spi.toFixed(2));
        }
    }

    /**
     * Fill drop-down menu (combo box) SPI index every time data change
     **/
    function riempiCampiMesi() {
        var datael = document.getElementById("data").value;
        $.getJSON("api/queries.php?funzione=1&data=" + datael, function (data) {
            var valoriSPI = [];
            for (i = 0; i < data.length; i++) {
                valoriSPI[i] = (data[i]["mese"]);
            }
            document.getElementById("mesi").innerHTML = '<option value="' + valoriSPI[0] + '">' + valoriSPI[0] + '</option>';
            for (i = 1; i < (valoriSPI.length); i++) {
                document.getElementById("mesi").innerHTML = document.getElementById("mesi").innerHTML + '<option value="' + valoriSPI[i] + '">' + valoriSPI[i] + '</option>';
            }
            mostraSPI();
        });
    }

    function getMed(vet = new Array()) { //Questo valore va nel db non calcolarlo qui
        var latv = [];
        var lonv = [];
        for (var i = 0; i < vet[0].length; i++) {
            latv[i] = vet[0][i][0]; //42..Latitudine utmy
            lonv[i] = vet[0][i][1]; //13..Logitudine utmx
        };
        var centroXY = [(Math.max(...latv) + Math.min(...latv)) / 2, (Math.max(...lonv) + Math.min(...lonv)) / 2];
        if (isNaN(centroXY[0])) {
            centroXY[0] = 0;
        }
        if (isNaN(centroXY[1])) {
            centroXY[1] = 0;
        }
        return centroXY;
    }

    //chOpac change opacity of grid layers
    function chOpac() {
        opacLay = (document.getElementById("opac").value / 100);
        //mostraSPI();
        chgColrs();
        document.getElementById("valOpac").innerHTML = opacLay;
    };
    var tmpJSON;
    var geojsonFeature = '{"type":"FeatureCollection", "features":['; //Used to store the GeoJSON string
    /**
     * Function draRemCelle() shows the grid with all cells 
     **/
    function draRemCelle() {
        if (document.getElementById("celid").checked == true) {
            mymap.removeLayer(layerGEO);
            celleGeo = L.geoJSON(tmpJSON).addTo(mymap);
            layerGEO.addTo(mymap);
        } else {
            mymap.removeLayer(celleGeo);
        }
    }
    /**
     * Function showHideSpiLay() shows or hide SPI layer
     **/
    function showHideSpiLay(){
        if(document.getElementById("siaD").checked == true){
            showSPI = true;
            layerGEO.addTo(mymap);
        }else{
            showSPI = false;
            mymap.removeLayer(layerGEO);
        }
    }

    /**
     * Function showPluvoStats() shows markers where pluviometric stations are located
     **/
    function showPluvoStats() {
        var stationsPl = '{"type":"FeatureCollection", "features":[';
        if (document.getElementById("pluid").checked == true) {
            //I have to make the first index out of the for beacause otherwise the comma goes on the last line.
            $.getJSON("api/queries.php?funzione=4", function (data) {
                stationsPl += '{"type":"Feature","geometry":{"type":"Point","coordinates":[' + JSON.parse(data[0]["Longitudine"]) + ',' + JSON.parse(data[0]["Latitudine"]) + ']},"properties":{"name":"' + data[0]["Nome"] + '","idSta":"' + data[0]["ID"] + '"}}';
                for (i = 1; i < data.length; i++) {
                    stationsPl += ',{"type":"Feature","geometry":{"type":"Point","coordinates":[' + JSON.parse(data[i]["Longitudine"]) + ',' + JSON.parse(data[i]["Latitudine"]) + ']},"properties":{"name":"' + data[i]["Nome"] + '","idSta":"' + data[i]["ID"] + '"}}';
                }
                stationsPl += ']}';
                statsPos = L.geoJSON(JSON.parse(stationsPl), {onEachFeature: setClickOnStat}).addTo(mymap);
            });
        } else {
            mymap.removeLayer(statsPos);
        }
    }

    /**
     * Function chCol change the SPI color palette 
     **/
    function chCol() {
        var valpath = document.getElementById("spicols").value;
        document.getElementById("colgimg").src = valpath;
        switch (valpath) {
            case "img/f.png": //Spectral
                SPIcol = ['#104375', '#508fa6', '#a4ced2', '#f4eeeb79', '#ecc2ae', '#c26c61', '#a03136', '#7a0b24'];
                break;
            case "img/e.png": //RdBu
                SPIcol = ['#575da8', '#6ab5be', '#93e08a', '#fcf9b183', '#f4da92', '#e1a068', '#cd6145', '#b72131'];
                break;
            case "img/d.png": //RdYlBu
                SPIcol = ['#0e5aad', '#5e9dce', '#a3d8ec', '#faf9c079', '#eebe65', '#ce6b34', '#b62e10', '#af1d05'];
                break;
            case "img/c.png": //RdYlGn
                SPIcol = ['#1f9941', '#74b958', '#dadb74', '#faf6ad3b', '#f7d674', '#f9a052', '#fe3f15', '#ff1b05'];
                break;
            case "img/b.png": //Thereshold5
                SPIcol = ['#0000ff', '#0000ff', '#008000', '#d9dadb42', '#ffa500', '#ff0000', '#ff0000', '#a52a2a'];
                break;
            case "img/a.png": //Thereshold7
                SPIcol = ['#000', '#0000ff', '#008000', '#d9dadb42', '#ffa500', '#ff0000', '#a52a2a', '#a52a2a'];
                break;
        }
        //mostraSPI();
        chgColrs();
    }

    /**
     * Function mostraSPI() called when months SPI is selected
     * This function retrive SPI values and fit it in a GeoJSON format
     **/
    function mostraSPI() {
        document.getElementById("spin").style="display:inline-block;";
        var mesesel = document.getElementById("mesi").value;
        var datael = document.getElementById("data").value;
        $.getJSON("api/queries.php?funzione=2&mese=" + mesesel + "&data=" + datael, function (data) {
            geojsonFeature += '{"type":"Feature","geometry":{"type":"Polygon","coordinates":' + (data[0]["Poligono"]) + '},"properties":{"idCella":' + JSON.parse(data[0]["ID"]) + ',"spi":' + JSON.parse(data[0]["SPI"]) + ',"latCentroid":' + JSON.parse(data[0]["Centroide"])[0] + ',"lngCentroid":' + JSON.parse(data[0]["Centroide"])[1] + '}}';
            for (i = 1; i < data.length; i++) {
                geojsonFeature += ',{"type":"Feature","geometry":{"type":"Polygon","coordinates":' + (data[i]["Poligono"]) + '},"properties":{"idCella":' + JSON.parse(data[i]["ID"]) + ',"spi":' + JSON.parse(data[i]["SPI"]) + ',"latCentroid":' + JSON.parse(data[i]["Centroide"])[0] + ',"lngCentroid":' + JSON.parse(data[i]["Centroide"])[1] + '}}';
            }
            geojsonFeature += ']}';
            function getColor(d) {
                return d > 3 ? SPIcol[0] : //nero
                    d > 2 ? SPIcol[1] : //blu
                        d > 1.5 ? SPIcol[2] : //verde
                            d > -1.5 ? SPIcol[3] : //Grigio chiaro
                                d > -2 ? SPIcol[4] ://arancione
                                    d > -3 ? SPIcol[5] : //rosso
                                        d > -4 ? SPIcol[6] : //rosso scuro o marrone
                                            SPIcol[7];//Anomalo
            }
            /**
             *With this function colors are shown.
             **/
            function style(feature) {
                return {
                    fillColor: getColor(feature.properties.spi),
                    weight: 1,
                    opacity: opacLay,
                    color: getColor(feature.properties.spi),
                    dashArray: '1',
                    fillOpacity: opacLay
                };
            }
            //document.getElementsByTagName('body')[0].innerHTML = geojsonFeature;
            tmpJSON = JSON.parse(geojsonFeature);

            geojsonFeature = '{"type":"FeatureCollection", "features":['; //Solved issue, after data were showed the variable was fill of unused GeoJSON string and that was preventing to show the new data.
            //Previous layer is removed if the page hasn't been refreshed.
            //celleGeo = L.geoJSON(tmpJSON).addTo(mymap);//This show the blue grid!!!!!
            if (noRefresh) {
                mymap.removeLayer(layerGEO);
            }
            if(showSPI == true){
                layerGEO = L.geoJson(tmpJSON, { style: style, onEachFeature: onEachFeature }).addTo(mymap); //This show only the colored grid sections
            }else{
                layerGEO = L.geoJson(tmpJSON, { style: style, onEachFeature: onEachFeature });
            }
            //L.geoJSON(tmpJSON, {onEachFeature: onEachFeature}).addTo(mymap); //Adding on click show SPI value
            noRefresh = 1;
            document.getElementById("spin").style="display:none;";
        });
    }

    function chgColrs(){
        function getColor(d) {
            return d > 3 ? SPIcol[0] : //nero
                d > 2 ? SPIcol[1] : //blu
                    d > 1.5 ? SPIcol[2] : //verde
                        d > -1.5 ? SPIcol[3] : //Grigio chiaro
                            d > -2 ? SPIcol[4] ://arancione
                                d > -3 ? SPIcol[5] : //rosso
                                    d > -4 ? SPIcol[6] : //rosso scuro o marrone
                                        SPIcol[7];//Anomalo
        }
        /**
         *With this function colors are shown.
            **/
        function style(feature) {
            return {
                fillColor: getColor(feature.properties.spi),
                weight: 1,
                opacity: opacLay,
                color: getColor(feature.properties.spi),
                dashArray: '1',
                fillOpacity: opacLay
            };
        }
        if (noRefresh) {
            mymap.removeLayer(layerGEO);
        }
        if(showSPI == true){
            layerGEO = L.geoJson(tmpJSON, { style: style, onEachFeature: onEachFeature }).addTo(mymap); //This show only the colored grid sections
        }/*else{
            layerGEO = L.geoJson(tmpJSON, { style: style, onEachFeature: onEachFeature });
        }*/
    }

    function disableDrag() {
        mymap.dragging.disable();
    }

    function enableDrag() {
        mymap.dragging.enable();
    }

    function pluvoGraphMonthly(){
        lstCldM = true;
        if(oldGraph == false){
            var selmonth = document.getElementById("selmo").value;
            if (selmonth != undefined && selmonth != "" && selmonth != "0") {
                document.getElementById("spon").style="display:inline-block;";
                $.getJSON("api/queries.php?funzione=7&slm=" + selmonth + "&id=" + idDivPrec, function (data) {
                    var dataText = "";
                    var sum = 0;
                    var avg = 0;
                    var first = 0;
                    for (i = 0; i < data.length; i++) {
                        if(data[i]["Anno"] > 0){
                            if (first == 0) {
                                dataText = (dataText + '[{"date":"' + data[i]["Anno"] + '", "value":' + data[i]["Valore"] + '}');
                                first = 1;
                            } else {
                                dataText = (dataText + ',{"date":"' + data[i]["Anno"] + '", "value":' + data[i]["Valore"] + '}');
                            }
                            sum = sum + data[i]["Valore"];
                        }
                    }
                    avg = (sum / (data.length));
                    dataText = dataText + ']';
                    var jsonData = JSON.parse(dataText);
                    var chart = AmCharts.makeChart( "chdivg", {
                        "type": "serial",
                        "theme": "none",
                        "dataProvider": jsonData,
                        "valueAxes": [ {
                            "gridColor": "#FFFFFF",
                            "gridAlpha": 0.2,
                            "dashLength": 0
                        } ],
                        "gridAboveGraphs": true,
                        "startDuration": 1,
                        "graphs": [ {
                            "balloonText": "[[date]]: <b>[[value]]</b>",
                            "fillAlphas": 0.8,
                            "lineAlpha": 0.2,
                            "type": "column",
                            "valueField": "value"
                        } ],
                        "chartCursor": {
                            "categoryBalloonEnabled": false,
                            "cursorAlpha": 0,
                            "zoomable": false
                        },
                        "categoryField": "date",
                        "categoryAxis": {
                            "gridPosition": "start",
                            "gridAlpha": 0,
                            "tickPosition": "start",
                            "tickLength": 20,
                            "axisColor": "transparent"
                        },
                        "export": {
                            "enabled": true
                        }
                    });
                    document.getElementById("spon").style="display:none;";
                });
            }
        }else{
            pluvoGraphMonthlyOld();
        }
    }

    /**
     * User select a month and that month is show for each year available for that station
    */
    function pluvoGraphMonthlyOld() {
        lstCldM = true;
        document.getElementById("oldGraph").checked = true;
        var selmonth = document.getElementById("selmo").value;
        if (selmonth != undefined && selmonth != "" && selmonth != "0") {
            document.getElementById("spon").style="display:inline-block;";
            $.getJSON("api/queries.php?funzione=7&slm=" + selmonth + "&id=" + idDivPrec, function (data) {
                var dataText = "";
                var sum = 0;
                var avg = 0;
                for (i = 0; i < data.length; i++) {
                    if (i == 0) {
                        dataText = (dataText + '[{"date":"' + data[i]["Anno"] + "-" + selmonth + '", "media":' + data[i]["Valore"] + '}');
                    } else {
                        dataText = (dataText + ',{"date":"' + data[i]["Anno"] + "-" + selmonth + '", "media":' + data[i]["Valore"] + '}');
                    }
                    sum = sum + data[i]["Valore"];
                }
                avg = (sum / (data.length));
                dataText = dataText + ']';
                var jsonData = JSON.parse(dataText);
                var chart = AmCharts.makeChart("chdivg", {
                    "type": "serial",
                    "theme": "light",
                    "marginRight": 80,
                    "marginTop": 17,
                    "autoMarginOffset": 20,
                    "dataProvider": jsonData,
                    "mediaueAxes": [{
                        "logarithmic": true,
                        "dashLength": 1,
                        "guides": [{
                            "dashLength": 6,
                            "inside": true,
                            "label": "media",
                            "lineAlpha": 1,
                            "mediaue": avg
                        }],
                        "position": "left"
                    }],
                    "graphs": [{
                        "bullet": "round",
                        "id": "g1",
                        "bulletBorderAlpha": 1,
                        "bulletColor": "#FFFFFF",
                        "lineColor": "#dd6108",
                        "bulletSize": 4,
                        "lineThickness": 1,
                        "title": "Monthly",
                        "type": "smoothedLine",
                        "useLineColorForBulletBorder": true,
                        "valueField": "media"
                    }],
                    "chartScrollbar": {},
                    "chartCursor": {
                        "valueLineEnabled": true,
                        "valueLineBalloonEnabled": true,
                        "valueLineAlpha": 0.5,
                        "fullWidth": true,
                        "cursorAlpha": 0.05
                    },
                    "dataDateFormat": "YYYY-MM",
                    "categoryField": "date",
                    "categoryAxis": {
                        "parseDates": true
                    }
                });
                document.getElementById("spon").style="display:none;";
            });
        }
    }

    function pluvoGraphDaily() {
        lstCldM = false;
        if(oldGraph == false){
            var startdate = document.getElementById("indt").value;
            var endate = document.getElementById("fidt").value;
            if (startdate != undefined && startdate != "" && endate != undefined && endate != "") {
                document.getElementById("spon").style="display:inline-block;";
                $.getJSON("api/queries.php?funzione=6&st=" + startdate + "&fi=" + endate + "&id=" + idDivPrec, function (data) {
                    if (data != null) {
                        var dataText = "";
                        var sum = 0;
                        var avg = 0;
                        var names = [];
                        for (i = 0; i < data.length; i++) {
                            names[i] = (data[i]["Data"] + "");
                            if (i == 0) {
                                dataText = (dataText + '[{"date":"' + data[i]["Data"] + '", "value":' + data[i]["Valore"] + '}');
                            } else {
                                dataText = (dataText + ',{"date":"' + data[i]["Data"] + '", "value":' + data[i]["Valore"] + '}');
                            }
                            sum = sum + data[i]["Valore"];
                        }
                        avg = (sum / (data.length));
                        dataText = dataText + ']';
                        var jsonData = JSON.parse(dataText);
                        var chart = AmCharts.makeChart( "chdivg", {
                            "type": "serial",
                            "theme": "none",
                            "dataProvider": jsonData,
                            "valueAxes": [{
                                "gridColor": "#FFFFFF",
                                "gridAlpha": 0.2,
                                "dashLength": 0
                            } ],
                            "gridAboveGraphs": true,
                            "startDuration": 1,
                            "graphs": [{
                                "balloonText": "[[date]]: <b>[[value]]</b>",
                                "fillAlphas": 0.8,
                                "lineAlpha": 0.2,
                                "lineColor": "#337ff0",
                                "type": "column",
                                "valueField": "value"
                            } ],
                            "chartCursor": {
                                "categoryBalloonEnabled": false,
                                "cursorAlpha": 0,
                                "zoomable": false
                            },
                            "categoryField": "date",
                            "categoryAxis": {
                                "gridPosition": "start",
                                "gridAlpha": 0,
                                "tickPosition": "start",
                                "tickLength": 20,
                                "axisColor": "transparent"
                            },
                            "export": {
                                "enabled": true
                            }
                        });
                        document.getElementById("spon").style="display:none;";
                    } else {
                        document.getElementById("chdivg").innerHTML = '<br/><h3 style="text-align:center;">No data available for the selected range!</h3>';
                    }
                });
            }
        }else{
            pluvoGraphDailyOld();
        }
    }

    /**
     * User select a date range and data are shown for that range. 
     */
    function pluvoGraphDailyOld() {
        lstCldM = false;
        document.getElementById("oldGraph").checked = true;
        var startdate = document.getElementById("indt").value;
        var endate = document.getElementById("fidt").value;
        if (startdate != undefined && startdate != "" && endate != undefined && endate != "") {
            document.getElementById("spon").style="display:inline-block;";
            $.getJSON("api/queries.php?funzione=6&st=" + startdate + "&fi=" + endate + "&id=" + idDivPrec, function (data) {
                if (data != null) {
                    var dataText = "";
                    var sum = 0;
                    var avg = 0;
                    var names = [];
                    for (i = 0; i < data.length; i++) {
                        names[i] = (data[i]["Data"] + "");
                        if (i == 0) {
                            dataText = (dataText + '[{"date":"' + data[i]["Data"] + '", "media":' + data[i]["Valore"] + '}');
                        } else {
                            dataText = (dataText + ',{"date":"' + data[i]["Data"] + '", "media":' + data[i]["Valore"] + '}');
                        }
                        sum = sum + data[i]["Valore"];
                    }
                    avg = (sum / (data.length));
                    dataText = dataText + ']';
                    var jsonData = JSON.parse(dataText);
                    am4core.ready(function () {
                        // Themes begin
                        am4core.useTheme(am4themes_animated);
                        // Themes end
                        var chart = am4core.create("chdivg", am4charts.XYChart);
                        var dati = [];
                        var value = 120;
                        for (var i = 0; i < names.length; i++) {
                            value = data[i]["Valore"];
                            dati.push({ category: names[i], value: value});
                        }
                        chart.data = dati;
                        var categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
                        categoryAxis.renderer.grid.template.location = 0;
                        categoryAxis.dataFields.category = "category";
                        categoryAxis.renderer.minGridDistance = 15;
                        categoryAxis.renderer.grid.template.location = 0.5;
                        categoryAxis.renderer.grid.template.strokeDasharray = "1,3";
                        categoryAxis.renderer.labels.template.rotation = -90;
                        categoryAxis.renderer.labels.template.horizontalCenter = "left";
                        categoryAxis.renderer.labels.template.location = 0.5;
                        categoryAxis.renderer.labels.template.adapter.add("dx", function (dx, target) {
                            return -target.maxRight / 2;
                        });
                        var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
                        valueAxis.tooltip.disabled = true;
                        valueAxis.renderer.ticks.template.disabled = true;
                        valueAxis.renderer.axisFills.template.disabled = true;
                        var series = chart.series.push(new am4charts.ColumnSeries());
                        series.dataFields.categoryX = "category";
                        series.dataFields.valueY = "value";
                        series.tooltipText = "{valueY.value}";
                        series.sequencedInterpolation = true;
                        series.fillOpacity = 0;
                        series.strokeOpacity = 1;
                        series.strokeDashArray = "1,3";
                        series.columns.template.width = 0.01;
                        series.tooltip.pointerOrientation = "horizontal";
                        var bullet = series.bullets.create(am4charts.CircleBullet);
                        chart.cursor = new am4charts.XYCursor();
                        chart.scrollbarX = new am4core.Scrollbar();
                        chart.scrollbarY = new am4core.Scrollbar();
                    });
                    document.getElementById("spon").style="display:none;";
                } else {
                    document.getElementById("chdivg").innerHTML = '<br/><h3 style="text-align:center;">No data available for the selected range!</h3>';
                }
            });
        }
    };
    var legend = L.control({ position: 'topleft' });//This move the controls with drop down menu on top left of screen
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legenda');
        div.innerHTML = '<div class="mainBar"><span>Date <select id="data" onchange="riempiCampiMesi()"><option value="2020-12-01">2020-12</option></select></span><span> SPI scale <select id="mesi" onchange="mostraSPI()"><option value="1">1</option></select></span><span>SPI palette <select id="spicols" onchange="chCol()"><option value="img/f.png">Spectral</option><option value="img/e.png">RedBlu</option><option value="img/d.png">RedYellowlBlu</option><option value="img/c.png">RedYellowGreen</option><option value="img/b.png">Threshold5</option><option value="img/a.png" selected="">Threshold7</option></select></span><div id="spin"></div></div><div id="colleg"><img id="colgimg" onmouseover="disableDrag()" onmouseout="enableDrag()" src="img/a.png"/><div id="opaDiv"><span>Opacity:</span><input type="range" min="0" max="100" value="70" class="slider" id="opac" onmouseover="disableDrag()" onmouseout="enableDrag()" onchange="chOpac()"/><span id="valOpac">0.7</span></div></div>';
        div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
        return div;
    }; //This add the div section that contains the drop down menu called mainBar
    legend.addTo(mymap); //Adding the mainBar to the map
    legend.getContainer().addEventListener('mouseover', disableDrag);
    legend.getContainer().addEventListener('mouseout', enableDrag);
    document.getElementsByClassName('legenda leaflet-control')[0].style = "top:20px;left:16px;";//Changing the position of the main bar
    document.getElementsByClassName('leaflet-control-container')[0].append(document.getElementsByClassName('legenda leaflet-control')[0]); //Changing the position in the document tree
    var imel = document.createElement("img"); //Adding an icon for layer satellite
    imel.setAttribute("src", "img/s.png");
    imel.setAttribute("width", "14");
    imel.setAttribute("style", "padding-left: 5px;vertical-align: middle;");
    var imal = document.createElement("img"); //Adding an icon for layer streets
    imal.setAttribute("src", "img/l.png");
    imal.setAttribute("width", "14");
    imal.setAttribute("style", "padding-left: 10px;vertical-align: middle;");
    document.getElementsByTagName('label')[0].append(imel); //Appending the image to the label (street, satellite)
    document.getElementsByTagName('label')[1].append(imal);
    document.getElementsByTagName('label')[0].firstChild.style = "display: inline;"; //Changing css of those labels
    document.getElementsByTagName('label')[1].firstChild.style = "display: inline;";
    riempiCampiData();//When everything is done the function to fill the data drop-down menu is called
    document.getElementsByClassName('leaflet-control-container')[0].append(document.getElementById("colleg"));
    document.getElementsByClassName('leaflet-control-layers-selector')[2].checked = false;//The radious button have the same class.
    document.getElementsByClassName('leaflet-control-layers-selector')[2].parentElement.style="display:none;";
    var celLayer = document.createElement('label');
    celLayer.innerHTML = '<div><input type="checkbox" id="celid" class="leaflet-control-layers-selector" onclick="draRemCelle()"/><span>Cells</span></div>';
    var spiLay = document.createElement('label');
    spiLay.innerHTML = '<div><input type="checkbox" id="siaD" class="leaflet-control-layers-selector" onclick="showHideSpiLay()" checked/><span>SPI Layer</span></div>';
    var pluvLay = document.createElement('label');
    pluvLay.innerHTML = '<div><input type="checkbox" id="pluid" class="leaflet-control-layers-selector" onclick="showPluvoStats()"/><span>Stations</span></div>';
    document.getElementsByClassName("leaflet-control-layers-overlays")[0].append(celLayer);
    document.getElementsByClassName("leaflet-control-layers-overlays")[0].append(spiLay);
    document.getElementsByClassName("leaflet-control-layers-overlays")[0].append(pluvLay);
    //If the used browser is Internet Explorer (not supported) or Microsoft Edge (old version supported)
    //This if move the mainbar at the top of body in this way it works
    if (navigator.userAgent.search(".NET") >= 0 || navigator.userAgent.search("Edge/18") >= 0) {
        document.getElementsByClassName('legenda leaflet-control')[0].style = "top:20px;left:16px;font-size:12px;";
        document.getElementsByTagName("body")[0].insertBefore(document.getElementsByClassName('legenda leaflet-control')[0], document.getElementsByTagName("body")[0].firstChild);
    }
    if (window.innerWidth < 720) {
        alert("Screen resolution could not be supported!");
    }
</script>
</html>